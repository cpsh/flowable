Zookeeper
Zookeeper作为Hadoop和Hbase的重要组件，可以为分布式应用程序协调服务，同时还能使用Java和C接口。
Zookeeper是一种分布式协调服务，用于管理大型主机。在分布式环境中协调和管理服务是一个复杂的过程。Zookeeper简单的架构和API很好的解决了这个问题。
Zookeeper概述
分布式应用
分布式应用可以在给定时间（同时）在网络中的多个系统上运行，通过协调以快速有效的方式完成特定任务。通常而言，对于复杂而耗时的任务，非分布式应用（单系统中应用）需要较长时间，而分布式系统则可以大幅缩短所需时间。
通过将分布式应用配置在更多系统上运行，可以进一步减少完成任务的时间。分布式应用正在运行的一组系统称为集群，而在集群中运行的媚态机器被称为节点。
分布式应用有两部分，Server（服务器）和Client（客户端）应用程序。服务器应用程序实际上是分布式的，并具有通用接口，以便客户端可以连接到集群中的任何服务器并获得相同的结果。客户端应用程序是与分布式应用进行交互的工具。
分布式应用的优点
1.可靠性：单个或几个系统的故障不会使整个系统出现故障
2.可扩展性：可以在需要时增加性能，通过添加更多机器，在应用程序配置中进行微小的更改，而不会有停机时间
3.透明性：隐藏系统的复杂性，并将其显示为单实体/应用程序
分布式应用的挑战
1.竞争条件：两个或多个机器尝试执行特定任务时，实际上只能在同一时间由单个机器完成，共享资源在同一时间只能由单个机器修改。
2.死锁：两个或多个操作等待彼此无限期完成
3.不一致：数据部分失败
Zookeeper
Apache Zookeeper是有集群（节点组）使用的一种服务，用于在自身之间协调，并通过稳健的同步技术维护共享数据。Zookeeper本身是一个分布式应用程序，为写入分布式应用程序提供服务。
Zookeeper提供常见的服务
1.命名服务 按名称标识集群中的节点，类似于DNS，但仅对于节点
2.配置管理 加入节点的最新的系统配置信息
3.集群管理 实时地在集群和节点状态中加入/移除节点
4.选举算法 选举一个节点作为协调目的的leader
5.锁定和同步服务 在修改数据的同时锁定数据 可帮助在链接其他分布式应用程序时进行自动故障恢复
6.高度可靠的数据注册表 即使一个或几个节点关闭时也可以获得数据
Zookeeper的好处
1.简单的分布式协调过程
2.同步 服务器进程之间的相互排斥和协作
3.序列化 根据特定规则对数据进行编码 确保应用程序运行一致
4.可靠性
5.原子性

Zookeeper基础
Architecture(架构)
Client(客户端)     客户端，分布式应用集群中的一个节点，访问服务器信息。特定的时间间隔，每个客户端向服务器发送消息以使服务器知道客户端是存活状态。类似的，当客户端连接时，服务器发送确认码。如果服务器没有响应则将重定向至另一台服务器
Server(服务器)     节点，为客户端提供服务，向客户端发送确认码以表示存活
Ensemble           Zookeeper服务器组，形成Ensemble最少需要3台服务器
Leader             服务器节点，如果任何连接的节点失效，则执行自动恢复。Leader在启动时自动选举
Follower           跟随Leader指令的服务器节点
层次命名空间
采取文件系统的树结构。Zookeeper节点称为znode，每个znode由一个名称标识，并用路径/序列分隔
例如
首先有一个/命名的zonde，为根目录。在此下有两个逻辑命名空间config和workers
config命名空间用于集中式配置管理，workers命令空间用于命名
config命名空间下，每个znode最多可存储1MB的数据。这个结构的主要目的是存储同步数据并描述znode的元数据，次结构称为Zookeeper数据模型
Zookeeper数据模型中的每个znode都维护一个stat结构，一个stat仅提供一个znode的元数据，由版本号，操作控制列表（ACL），时间戳和数据长度组成
1.版本号 每个znode都有版本号 意味着每当与znode相关联的数据发生变化时，其对应的版本号也会增加。当多个zookeeper客户端尝试在同一znode上执行操作时，版本号的使用就很重要
2.操作控制列表（ACL) ACL基本是访问znode的认证机制，管理所有读写操作
3.时间戳 时间戳表示创建和修改znode的时间，通常以毫秒为单位。Zookeeper以事务ID(zxid)标识znode的每个更改。zxid是唯一的，并且为每个事务保留时间，以便确定请求经历的时间
4.数据长度 存储在znode中的数据总量是数据长度 最多存储1MB的数据
Znode的类型
分为Persistent持久节点，Sequential顺序节点，ephemeral临时节点
1.持久节点(Persistent) 即使在创建该znode的客户端断开连接后，持久节点依旧存在，默认情况下，节点是持久节点
2.临时节点（Ephemeral) 客户端活跃时，临时节点是有效的，断开后自动删除。临时节点不允许有子节点，如果临时节点被删除，则下一个合适的节点将填充，临时节点在选举中起到重要作用
3.顺序节点（Sequential） 顺序节点可以是临时或永久的，当一个新的顺序节点被创建时，Zookeeper通过将10位序列号附加到原始名称来设置znode路径。如，将路径/myapp的znode创建为顺序节点则会将路径改为/myapp0000000001,下一个则是/myapp0000000002。不会有相同数字的znode，顺序节点在锁定和同步中起到重要作用。
Session(会话)
会话对于Zookeeper的操作非常虫咬，会话中的请求按FIFO顺序执行，一旦客户端连接到服务器，将建立会话并向客户端分配会话ID
客户端以特定的时间间隔发送心跳以确保会话有效，如果Zookeeper集群超过服务器指定时间间隔未收到心跳，则判定客户端死机
会话超时通常以毫秒为单位，当会话由于任何原因结束，在该会话期间创建的临时节点也会删除
Watches(监视)
监视是一种简单的机制，使客户端收到关于Zookeeper集群中的更改通知。客户端可以在读取znode时设置Watches,Watches会想注册的客户端发送任何znode（客户端注册表）更改的通知
Znode更改只触发一次Watches。想要再次通知，需要再次设置Watches。当连接会话过期，相关Watches也会被删除

Zookeeper工作流
Zookeeper启动将等待客户端连接。客户端连接到Zookeeper集群中的一个节点，可以是leader或follower。一旦客户端连接，节点将分配会话ID并向客户端发送确认，若客户端未接受到确认则将尝试连接集群中的另一个节点。一旦连接到节点，客户端将以固定时间间隔向节点发送心跳，以确保连接不会丢失。
1.如果客户端想要读取特定的znode，将会向具有znode路径的节点发送读取请求，并且节点通过从其读取返回，速度很快
2.如果客户端想要存储数据到特定的znode，则会将znode路径和数据发送到服务器。连接的服务器将该请求转发给leader，然后leader向所有的follower重新发出写入请求，如果大部分节点成功响应则写入成功，将成功响应码发送到客户端，如果大部分失败则返回失败
Zookeeper集合中的节点
由于自动恢复需要半数以上的节点确认，因此最少需要3个。
写入      写入过程由leader节点处理，leader将写请求转发到所有节点，并等待从节点的回复，超过一半回复成功则写入成功
读取      读取由连接的节点执行，无需与集群进行交互
复制数据库 用于在zookeeper中存储数据，每个节点都有自己的数据库，在一致性的帮助下拥有相同的数据
Leader    负责处理写入请求的Znode
Follower  可以单独处理读请求，而写请求需要转发给Leader
请求处理器 只存在于Leader节点，管理来自follower节点的写请求
原子广播   负责广播从leader节点到follower节点的变化

Zookeeper Leader选举
1.所有节点创建具有相同路径/app/leader_election/guid_的顺序、临时节点
2.Zookeeper集合将附加10位序列到路径，创建的znode将是/app/leader_election/guid_0000000001,/app/leader_election/guid_0000000002 ...
3.创建的znode数字最小的节点成为leader，其余变为follower
3.每个follower监视比自己数字小一个名次的节点
4.如果leader关闭，则其相应的znode/app/leader_election/guid_将被删除
5.下一个在线的follower节点将通过Watches获得leader移除的通知
6.下一个在线的follower检查是否存在更小数字的节点，有则最小数字称为leader，没有则本身称为leader

Zookeeper安装
需要先安装JDK
然后下载压缩包，解压，手动创建两个文件夹作为data和log存储的目录，修改conf/路径下的zoo.cfg(复制自zoo_sample.cfg)中的配置信息。最后将bin/配置到环境变量中（使用软连接会有问题）

Zookeeper CLI
Zookeeper命令行界面(CLI)用于于Zookeeper集合进行交互，有助于调试和解决不同的选项。
CLI中可以执行以下操作：
1.创建znode
2.获取数据
3.监视znode的变化
4.设置数据
5.创建znode的子节点
6.列出znode的子节点
7.检查状态
8.移除/删除znode
创建znode
用给定的路径创建一个znode，flag参数指定创建的znode是顺序的，永久的还是临时的。默认情况下，所有znode都是持久的。
当会话过期或客户端断开连接时，临时节点将被自动删除
顺序节点保证znode路径将是唯一的。
语法结构
create [options] /path /data
options可选
-s 顺序节点
-e 临时节点
获取数据
返回znode关联数据和元数据，例如上次修改数据的时间，修改的位置以及数据的相关信息，此命令还用于分配监视器以显示数据相关的通知
get /path 
监视（Watch）
当指定的znode或znode的子数据更改时，监视器会显示通知，只能在get命令中设置watch
语法结构
get /path [watch] 1
直接输出类似于get命令 但是会在后台等待znode变化
当znode改变时 输出类似
WATCHER::
WatchedEvent state:SyncConnected type:NodeDataChanged path:/sjbuluo/watch
设置数据
设置指定znode的数据 完成此设置操作后 可以使用get命令获取数据
set /path /data
创建子项/子节点
create /parent/path/subnode/path /data
列出子项
ls /path
检查状态
指定znode的元数据
stat /path
移除znode
移除指定znode并递归移除所有子节点
rmr /path
删除节点
只适用于没有子节点的节点
delete /path

Zookeeper API
使用API，应用程序可以连接、交互、操作数据、协调，断开连接。
具有丰富的功能，以简单和安全的方式获得Zookeeper集合的所有功能，提供异步和同步的方法
基础知识
客户端应该遵循以步骤，与Zookeeper结合进行清晰和干净的交互
1.连接到Zookeeper服务器，服务器分配为客户端分配会话ID
2.定期向服务器发送心跳，否则可能会话ID过期需要重新连接
3.只要会话ID处于活跃状态，就可以获取/设置znode
4.所有任务完成后，断开与Zookeeper集群的连接，长期不活动也会自动断开。
